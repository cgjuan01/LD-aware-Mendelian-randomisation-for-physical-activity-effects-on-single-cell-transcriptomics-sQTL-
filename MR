#!/usr/bin/env Rscript

suppressPackageStartupMessages({
  library(data.table)
  library(dplyr)
  library(TwoSampleMR)
  library(ieugwasr)
  library(MendelianRandomization)
})

# ---------- token bootstrap (accept OPENGWAS_JWT or IEU_TOKEN) ----------
get_ogw_token <- function() {
  t <- Sys.getenv("OPENGWAS_JWT", unset = "")
  if (!nzchar(t)) t <- Sys.getenv("IEU_TOKEN", unset = "")
  if (nzchar(t)) {
    Sys.setenv(OPENGWAS_JWT = t)
    if ("ieugwasr" %in% .packages(all.available = TRUE)) {
      if ("set_opengwas_jwt" %in% getNamespaceExports("ieugwasr")) {
        try(ieugwasr::set_opengwas_jwt(t), silent = TRUE)
      }
    }
  }
  t
}
.OPENGWAS_TOKEN <- get_ogw_token()

# ===================== CONFIG =====================
EXPOSURE_CSV <- "/Users/ciara/Downloads/fine-mapped-pa-snps.csv"

ONEK1K_DIR   <- "~/Downloads/OneK1K"
ONEK1K_FILES <- c(
  "QTD000606.all.tsv",  # CD4 T
  "QTD000607.all.tsv",  # CD8 T
  "QTD000608.all.tsv",  # B cell
  "QTD000609.all.tsv",  # Monocyte
  "QTD000610.all.tsv",  # NK cell
  "QTD000611.all.tsv"   # Dendritic cell
)

HARMONISE_ACTION <- 1     # use exposure EAF to resolve palindromes
LD_POP <- "EUR"
OUTDIR <- "~/Downloads/mr_ld_pa_scqtl"
dir.create(OUTDIR, recursive = TRUE, showWarnings = FALSE)

CELL_LABELS <- c(
  QTD000606 = "CD4_Tcell_unstim",
  QTD000607 = "CD8_Tcell_unstim",
  QTD000608 = "Bcell_unstim",
  QTD000609 = "Monocyte_unstim",
  QTD000610 = "NKcell_unstim",
  QTD000611 = "Dendritic_unstim"
)

# ===================== HELPERS =====================
std_rsid <- function(x){
  x <- trimws(as.character(x))
  x <- gsub("\\s+", "", x)
  x <- sub("^\\.*", "", x)
  x <- sub("^rs", "", x, ignore.case = TRUE)
  paste0("rs", x)
}

report_overlap <- function(exp_snps, out_snps, label){
  exp_u <- unique(exp_snps); out_u <- unique(out_snps)
  ov <- intersect(exp_u, out_u)
  message(sprintf(
    "Overlap for %-20s: %5d exposure SNPs × %7d outcome SNPs -> %4d intersect",
    label, length(exp_u), length(out_u), length(ov)
  ))
  ov
}

norm_cols_outcome <- function(dt) {
  setnames(dt, tolower(names(dt)))
  ren_old <- c("rsid","alt","ref","beta","se","pvalue",
               "gene_id","molecular_trait_id","molecular_trait_object_id","cell_type")
  ren_new <- c("snp","effect_allele","other_allele","beta","se","pval",
               "gene_id","gene_id","gene_id","cell_type")
  for (i in seq_along(ren_old)) if (ren_old[i] %in% names(dt)) setnames(dt, ren_old[i], ren_new[i], skip_absent=TRUE)

  if (!"snp" %in% names(dt)) stop("Outcome lacks rsIDs.")
  dt[, snp := std_rsid(snp)]
  if ("effect_allele" %in% names(dt)) dt[, effect_allele := toupper(effect_allele)]
  if ("other_allele"  %in% names(dt)) dt[,  other_allele := toupper(other_allele)]

  keep <- intersect(c("snp","effect_allele","other_allele","beta","se","pval","gene_id","cell_type"), names(dt))
  dt[, ..keep]
}

read_exposure <- function(path) {
  if (!file.exists(path)) stop("Exposure file not found: ", path)
  dt <- data.table::fread(path)
  setnames(dt, tolower(names(dt)))

  if (!"snp" %in% names(dt)) {
    cand <- intersect(c("rsid","snp","id","variant","rs_id"), names(dt))
    if (length(cand)) setnames(dt, cand[1], "snp")
  }
  if (!"effect_allele" %in% names(dt)) {
    cand <- intersect(c("ea","effect","a1","allele1"), names(dt)); if (length(cand)) setnames(dt, cand[1], "effect_allele")
  }
  if (!"other_allele" %in% names(dt)) {
    cand <- intersect(c("oa","other","a2","allele2"), names(dt)); if (length(cand)) setnames(dt, cand[1], "other_allele")
  }
  if (!"beta" %in% names(dt)) {
    cand <- intersect(c("b","beta_pa","effect","beta_exposure"), names(dt)); if (length(cand)) setnames(dt, cand[1], "beta")
  }
  if (!"se" %in% names(dt)) {
    cand <- intersect(c("se_pa","sebeta","se_exposure","stderr"), names(dt)); if (length(cand)) setnames(dt, cand[1], "se")
  }
  if (!"eaf" %in% names(dt)) {
    cand <- intersect(c("eaf_exposure","eafreq","af","maf","eaf_a1"), names(dt))
    if (length(cand)) setnames(dt, cand[1], "eaf") else dt[, eaf := NA_real_]
  }

  dt[, snp := std_rsid(snp)]

  # Pre-compute exposure p-values to avoid "Inferring p-values" path
  if (!"pval" %in% names(dt)) {
    if (all(c("beta","se") %in% names(dt))) {
      z <- as.numeric(dt$beta) / as.numeric(dt$se)
      dt[, pval := 2*pnorm(-abs(z))]
    } else {
      dt[, pval := NA_real_]
    }
  }

  as.data.frame(dplyr::transmute(
    dt,
    SNP = snp,
    beta.exposure = as.numeric(beta),
    se.exposure   = as.numeric(se),
    eaf.exposure  = as.numeric(eaf),
    pval.exposure = as.numeric(pval),
    effect_allele.exposure = toupper(effect_allele),
    other_allele.exposure  = toupper(other_allele),
    id.exposure = "PA_finemap",
    exposure    = "Vigorous PA (fine-mapped)"
  ))
}

format_exposure_for_TSMR <- function(exp_dt){
  exp_df <- as.data.frame(
    exp_dt %>% dplyr::rename(
      beta = beta.exposure, se = se.exposure,
      eaf  = eaf.exposure,  pval = pval.exposure,
      effect_allele = effect_allele.exposure,
      other_allele  = other_allele.exposure
    )
  )
  TwoSampleMR::format_data(
    exp_df,
    type = "exposure",
    snp_col = "SNP", beta_col = "beta", se_col = "se",
    effect_allele_col = "effect_allele", other_allele_col = "other_allele",
    eaf_col = "eaf", pval_col = "pval"
  )
}

# -------- LD matrix (OpenGWAS → LDlink → identity) --------
ld_api_matrix <- function(snps, pop = "EUR") {
  snps <- unique(snps)
  ogw_try <- try(ieugwasr::ld_matrix(variants = snps, with_alleles = FALSE, pop = pop), silent = TRUE)
  if (!inherits(ogw_try, "try-error")) return(as.matrix(ogw_try))

  if (nzchar(Sys.getenv("LD_ACCESS_TOKEN", "")) && requireNamespace("LDlinkR", quietly=TRUE)) {
    message("Falling back to LDlinkR LDmatrix() …")
    idx <- split(seq_along(snps), ceiling(seq_along(snps)/300))
    mats <- lapply(idx, function(ix) LDlinkR::LDmatrix(snps = snps[ix], pop="EUR", r2d="r2", file=FALSE))
    dims <- vapply(mats, nrow, 1L)
    Mbd <- matrix(0, sum(dims), sum(dims))
    r <- 1; c <- 1
    for (k in seq_along(mats)) {
      m <- as.matrix(mats[[k]]); d <- nrow(m)
      Mbd[r:(r+d-1), c:(c+d-1)] <- m
      r <- r+d; c <- c+d
    }
    rownames(Mbd) <- colnames(Mbd) <- unlist(lapply(mats, rownames))
    keep <- intersect(snps, rownames(Mbd))
    return(Mbd[keep, keep, drop=FALSE])
  }

  warning("⚠️ Using identity LD (independence assumed).")
  I <- diag(length(snps)); rownames(I) <- colnames(I) <- snps; I
}

make_pd <- function(M) {
  eig <- eigen(M, symmetric=TRUE)
  if (min(eig$values) > 1e-8) return(M)
  M + diag(abs(min(eig$values)) + 1e-6, nrow(M))
}

run_ld_mr <- function(hdat, LD) {
  ord <- match(hdat$SNP, rownames(LD))
  LD <- LD[ord, ord, drop=FALSE]
  bx <- hdat$beta.exposure; bxse <- hdat$se.exposure
  by <- hdat$beta.outcome;  byse <- hdat$se.outcome
  inp <- MendelianRandomization::mr_input(bx=bx,bxse=bxse,by=by,byse=byse,correlation=LD)
  ivw   <- MendelianRandomization::mr_ivw(inp)
  egger <- MendelianRandomization::mr_egger(inp)
  list(ivw=ivw, egger=egger)
}

# ===================== MAIN =====================
message("Reading exposure from: ", EXPOSURE_CSV)
exp_dt <- read_exposure(EXPOSURE_CSV)
message("Exposure SNPs (unique): ", length(unique(exp_dt$SNP)))
exp_fmt <- format_exposure_for_TSMR(exp_dt)

ALL_SUMMARY <- list()

for (f in ONEK1K_FILES) {
  qtid  <- sub("\\.all\\.tsv$", "", basename(f))
  label <- CELL_LABELS[[qtid]]; if (is.null(label)) label <- qtid
  infile <- file.path(ONEK1K_DIR, f)
  if (!file.exists(infile)) { warning("Missing file: ", infile); next }

  message("\n=== Outcome: ", label, " ===")
  out_raw <- data.table::fread(infile, nThread=4, showProgress=TRUE)
  out_dt  <- norm_cols_outcome(out_raw)
  message("Outcome rows (all genes): ", nrow(out_dt))

  ov <- report_overlap(exp_dt$SNP, out_dt$snp, label)
  if (length(ov)==0) next
  out_dt <- out_dt[snp %in% ov]

  if (!"gene_id" %in% names(out_dt)) { warning("Outcome lacks gene_id; skipping ", label); next }
  genes <- unique(out_dt$gene_id)
  message("Genes with overlapping SNPs: ", length(genes))

  RES_CELL <- list()
  for (g in genes) {
    gdt <- out_dt[gene_id==g]
    if ("pval" %in% names(gdt)) { setorder(gdt, snp, pval); gdt <- unique(gdt, by="snp") } else gdt <- unique(gdt, by="snp")

    out_df <- as.data.frame(gdt %>% dplyr::rename(beta=beta,se=se,effect_allele=effect_allele,other_allele=other_allele))
    out_fmt <- TwoSampleMR::format_data(out_df, type="outcome",
      snp_col="snp", beta_col="beta", se_col="se",
      effect_allele_col="effect_allele", other_allele_col="other_allele")
    out_fmt$id.outcome <- paste0(label,"|",g)
    out_fmt$outcome    <- paste0(label,"|",g)

    hdat <- harmonise_data(exp_fmt, out_fmt, action=HARMONISE_ACTION)
    hdat <- hdat %>% dplyr::filter(!is.na(beta.exposure), !is.na(beta.outcome), !is.na(se.exposure), !is.na(se.outcome))
    if (nrow(hdat)==0) next

    if (nrow(hdat)==1) {
      bx<-hdat$beta.exposure; by<-hdat$beta.outcome
      bxse<-hdat$se.exposure; byse<-hdat$se.outcome
      beta_WR<-by/bx; se_WR<-sqrt((byse^2/bx^2)+((by^2*bxse^2)/bx^4))
      p<-2*pnorm(-abs(beta_WR/se_WR))
      RES_CELL[[g]]<-data.frame(cell=label,gene=g,method="Wald ratio",nsnp=1,
                                beta=beta_WR,se=se_WR,pval=p)
      next
    }

    LD <- ld_api_matrix(hdat$SNP, pop=LD_POP)
    LD <- make_pd(LD)
    fit <- run_ld_mr(hdat, LD)

    ivw_row <- data.frame(cell=label,gene=g,method="LD-IVW",nsnp=nrow(hdat),
                          beta=fit$ivw@Estimate,se=fit$ivw@StdError,pval=fit$ivw@Pvalue,
                          egger_intercept=NA,egger_intercept_se=NA,egger_intercept_p=NA)
    eg_est <- tryCatch(fit$egger@Estimate,       error=function(e) NA_real_)
    eg_se  <- tryCatch(fit$egger@StdError.Est,   error=function(e) NA_real_)
    eg_p   <- tryCatch(fit$egger@Pvalue.Est,     error=function(e) NA_real_)
    eg_int <- tryCatch(fit$egger@Intercept,      error=function(e) NA_real_)
    eg_iSE <- tryCatch(fit$egger@StdError.Int,   error=function(e) NA_real_)
    eg_iP  <- tryCatch(fit$egger@Pvalue.Int,     error=function(e) NA_real_)

    egger_row <- data.frame(cell=label,gene=g,method="LD-Egger",nsnp=nrow(hdat),
                            beta=eg_est,se=eg_se,pval=eg_p,
                            egger_intercept=eg_int,egger_intercept_se=eg_iSE,egger_intercept_p=eg_iP)

    RES_CELL[[g]] <- rbind(ivw_row, egger_row)
  }

  if (length(RES_CELL)) {
    RES_CELL <- dplyr::bind_rows(RES_CELL)
    data.table::fwrite(RES_CELL, file.path(OUTDIR, paste0("mr_results_", label, ".csv")))
    ALL_SUMMARY[[label]] <- RES_CELL
    message("Saved per-gene MR for ", label)
  } else {
    warning("No MR results for ", label)
  }
}

if (length(ALL_SUMMARY)) {
  SUM <- dplyr::bind_rows(ALL_SUMMARY)
  data.table::fwrite(SUM, file.path(OUTDIR, "summary_all_celltypes_pergene.csv"))
  message("\nAll done → ", file.path(OUTDIR, "summary_all_celltypes_pergene.csv"))
} else {
  message("\nNo results produced (check overlap logs).")
}
